#!/bin/bash

echo "ğŸ§ª Testing Fulcrum ZK Circuit..."
echo "================================"
echo ""

CIRCUIT_NAME="ed25519_verifier"

# Check if circuit is compiled
if [ ! -f "build/circuits/${CIRCUIT_NAME}_js/${CIRCUIT_NAME}.wasm" ]; then
    echo "âŒ Circuit not compiled! Run: npm run compile"
    exit 1
fi

# Check if setup is done
if [ ! -f "build/keys/${CIRCUIT_NAME}_final.zkey" ]; then
    echo "âŒ Trusted setup not done! Run: npm run setup"
    exit 1
fi

echo "ğŸ“ Step 1: Generating witness from test input..."

# Create test input
cat > build/input.json << EOF
{
  "messageHash": "12345678901234567890123456789012",
  "publicKeyHash": "98765432109876543210987654321098",
  "signatureR": ["1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0"],
  "signatureS": ["0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1","0","1"],
  "publicKeyX": ["1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0"],
  "publicKeyY": ["0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1","1","0","0","1"]
}
EOF

echo "âœ… Test input created"
echo ""

echo "ğŸ“Š Step 2: Computing witness..."

node build/circuits/${CIRCUIT_NAME}_js/generate_witness.js \
  build/circuits/${CIRCUIT_NAME}_js/${CIRCUIT_NAME}.wasm \
  build/input.json \
  build/witness.wtns

if [ $? -ne 0 ]; then
    echo "âŒ Witness generation failed!"
    exit 1
fi

echo "âœ… Witness generated"
echo ""

echo "ğŸ” Step 3: Generating proof..."

npx snarkjs groth16 prove \
  build/keys/${CIRCUIT_NAME}_final.zkey \
  build/witness.wtns \
  build/proof.json \
  build/public.json

if [ $? -ne 0 ]; then
    echo "âŒ Proof generation failed!"
    exit 1
fi

echo "âœ… Proof generated"
echo ""

echo "âœ”ï¸  Step 4: Verifying proof..."

npx snarkjs groth16 verify \
  build/keys/verification_key.json \
  build/public.json \
  build/proof.json

if [ $? -ne 0 ]; then
    echo "âŒ Proof verification failed!"
    exit 1
fi

echo "âœ… Proof verified successfully!"
echo ""

echo "ğŸ“‹ Test Summary:"
echo "================"
echo "âœ… Circuit compilation: OK"
echo "âœ… Witness generation: OK"
echo "âœ… Proof generation: OK"
echo "âœ… Proof verification: OK"
echo ""
echo "Generated files:"
echo "  - build/proof.json (ZK proof)"
echo "  - build/public.json (Public signals)"
echo "  - build/witness.wtns (Witness)"
echo ""
echo "âœ… All tests passed!"
